---
title: "ASHRAE Energy Prediction - Exploratory Data Analysis"
output: html_notebook
---


## Setup    
  Load the relevant libraries.
```{r message=TRUE, warning=TRUE}

# rm(list = ls())
# .rs.restartR()


# data munging
library("tidyverse")
library("data.table")
library("tidyquant")    # rolling calculations

# munge dates
library("lubridate")


# viz
library("plotly")




library("tictoc")

# get tweets
# library("rtweet")

# NLP
# library("tidytext")
# library("syuzhet")
# library("googleLanguageR")

# graph analyses
# library("tidygraph")
# library("ggraph")

# # feature engineering and data prep
# library("recipes")
# library("caret")
# library("DMwR")
# 
# # to explore missing data
# library("visdat")
# library("naniar")
# 
# # modeling
# library("h2o")

```
  
    
  Session Info.
```{r}

sessionInfo()

```


  Setup the root directory.
```{r "setup", include = FALSE}

require("knitr")


# Use when running from AWS
# opts_knit$set(root.dir = "/home/rstudio/Dropbox/_AWS/twitter_dc_metro2/")


if (str_detect(string = getwd(),
               pattern = "mdturse"
               )
    ) {
  # Use when running from laptop
  opts_knit$set(root.dir = "/Users/mdturse/Desktop/Analytics/ashrae_energy_prediction/")
  } else {
    # Use when running from Sparkfund laptop
    opts_knit$set(root.dir = "/Users/danielturse/Desktop/Projects/ashrae_energy_prediction/")
  }


# Use when running from laptop
# opts_knit$set(root.dir = "/Users/mdturse/Desktop/Analytics/ashrae_energy_prediction/")

# Use when running from Sparkfund laptop
# opts_knit$set(root.dir = "/Users/danielturse/Desktop/Projects/ashrae_energy_prediction/")

```
  
    
  Setting `wd` as the working directory.
```{r}

wd <- getwd()

wd

```


## Get the Data  

```{r}

file_names <-
  list.files(path = paste0(wd,
                           "/Data/Raw"
                           )
             )

tic()

files_list <-
  file_names %>% 
  # map(~read_csv(file = paste0(wd,
  #                             "/Data/Raw/",
  #                             .x
  #                             )
  #               )
  #     )
  map(~fread(file = paste0(wd,
                           "/Data/Raw/",
                           .x
                           )
             )
      )

toc()


names(files_list) <-
  file_names %>% 
  str_replace(pattern = ".csv",
              replacement = ""
              )

glimpse(files_list)

```
  
    
  Quick update of formats.
```{r}

# colnames(files_list$weather_train) %>% has_element("timestamp")

files_list <-
  pmap(.l = list(a = files_list),
       .f = function(a) {
         # update timestamp
         if (colnames(a) %>% has_element("timestamp")
             ) {
           dat = a[ ,
                   `:=` (timestamp = as_datetime(timestamp)
                         )
                   ]
           } else {
           dat = a
           }
         
         # create meter_reading logged
         if (colnames(dat) %>% has_element("meter_reading")
             ) {
           dat2 = dat[ ,
                      `:=` (meter_reading_log = log(meter_reading + 1)
                            )
                      ]
           } else {
           dat2 = dat
           }
         
         return(dat2)
         }
       )

glimpse(files_list)

```


## Basic Investigation  
  
### Counts of buildings and meters and (buildings and meters).
```{r}

cnts_bldg_mtr <-
  files_list$train %>% 
  count(building_id,
        meter,
        # timestamp
        ) %>% 
  left_join(y = files_list$train %>% 
              filter(meter_reading > 0) %>% 
              count(building_id,
                    meter
                    ) %>% 
              rename(n_non0 = n),
            by = c("building_id" = "building_id",
                   "meter" = "meter"
                   )
            ) %>% 
  mutate(n_non0_pct = n_non0 / n) %>% 
  arrange(building_id,
          meter
          )

cnts_bldg_mtr



cnts_bldg <-
  cnts_bldg_mtr %>% 
  count(building_id,
        wt = n
        ) %>% 
  left_join(y = cnts_bldg_mtr %>% 
              count(building_id,
                    wt = n_non0
                    ) %>% 
              rename(n_non0 = n),
            by = "building_id"
            ) %>% 
  mutate(n_non0_pct = n_non0 / n)

cnts_bldg


cnts_mtr <-
  cnts_bldg_mtr %>% 
  count(meter,
        wt = n
        ) %>% 
  left_join(y = cnts_bldg_mtr %>% 
              count(meter,
                    wt = n_non0
                    ) %>% 
              rename(n_non0 = n),
            by = "meter"
            ) %>% 
  mutate(n_non0_pct = n_non0 / n)

cnts_mtr



files_list$building_metadata %>% 
  count(primary_use) %>% 
  arrange(desc(n))


rm(cnts_bldg_mtr, cnts_bldg, cnts_mtr)

```

### Weather Inspection  
  
  Yearly Weather.
```{r}

test_hourly_overyear <-
  files_list$weather_train[site_id < 10] %>% 
  split(.$site_id)

test_hourly_overyear <-
  pmap(.l = list(a = test_hourly_overyear),
       .f = function(a) {
         dat = a[ ,
                 .(timestamp,
                   air_temperature
                   )
                 ] %>% 
           setkey(timestamp,
                  air_temperature
                  ) %>% 
           unique()
         
         dat = dat[ ,
                   `:=` (wkday = wday(timestamp, label = TRUE),
                         hr = hour(timestamp)
                         )
                   ]
         
         return(dat)
         }
       )

test_hourly_overyear$`0` %>% str()
View(test_hourly_overyear$`0`)

```
  
    
  Line graph yearly.
```{r}

line_hrly_overyear <-
  pmap(.l = list(a = test_hourly_overyear,
                 b = names(test_hourly_overyear)
                 ),
       .f = function(a, b) {
         ggplot(data = a,
                aes(x = timestamp,
                    y = air_temperature
                    )
                ) +
           geom_line() +
           theme_minimal() +
           labs(title = paste0("site_id: ", b)
                ) +
           NULL
         }
       )

line_hrly_overyear

```
  
    
  Daily Weather
```{r}

test_hourly_overday <-
  pmap(.l = list(a = test_hourly_overyear),
       .f = function(a) {
         dat = a[ ,
                 .(temp_air_mean = mean(air_temperature, na.rm = TRUE)
                   ),
                 by = list(wkday, hr)
                 ]
         
         return(dat)
         }
       )
  
glimpse(test_hourly_overday$`0`)
View(test_hourly_overday$`0`)


line_hrly_overday <-
  pmap(.l = list(a = test_hourly_overday,
                 b = names(test_hourly_overday)
                 ),
       .f = function(a, b) {
         a %>% 
           ggplot(aes(x = hr,
                      y = temp_air_mean,
                      colour = wkday
                      )
                  ) +
           geom_line() +
           facet_wrap(vars(wkday)
                      ) +
           theme_minimal() +
           theme(legend.position = "none") +
           labs(title = paste0("site_id: ", b)
                ) +
           NULL
       }
     )

line_hrly_overday

```


### Energy Use Inspection  
  
  Limit to certain buildings.
```{r}

map_sites_buildings <-
  files_list$building_metadata[site_id < 10,
                               .(site_id,
                                 building_id
                                 )
                               ] %>% 
  unique()

# View(map_sites_buildings)


buildings <-
  files_list$train[meter == 0 &
                     building_id %in% map_sites_buildings$building_id
                   ][ ,
                     `:=` (date = as_date(timestamp),
                           wkday = wday(timestamp, label = TRUE),
                           hr = hour(timestamp)
                           )
                     ]

buildings <-
  buildings %>% 
  merge(y = files_list$building_metadata,
        by.x = "building_id",
        by.y = "building_id",
        all.x = TRUE
        ) %>% 
  setkey(site_id,
         building_id,
         timestamp
         )

str(buildings)

# View(buildings %>% head(1000))

```


```{r}

meter_reading_by_site_day_hr <-
  buildings[ ,
            .(meter_reading_mean = mean(meter_reading, na.rm = TRUE)
              ),
            by = list(site_id, wkday, hr)
            ] %>% 
  split(.$site_id)

str(meter_reading_by_site_day_hr$`0`)


line_hrly_energy_overday <-
  pmap(.l = list(a = meter_reading_by_site_day_hr,
                 b = names(meter_reading_by_site_day_hr)
                 ),
       .f = function(a, b) {
         ggplot(data = a,
                aes(x = hr,
                    y = meter_reading_mean,
                    colour = wkday
                    )
                ) +
           geom_line() +
           facet_wrap(vars(wkday)
                      ) +
           labs(title = paste0("Electric Readings \n", "site_id: ", b)
                ) +
           theme_minimal() +
           theme(legend.position = "none") +
           NULL
       }
     )

line_hrly_energy_overday

```



```{r}

meter_reading_by_site_day <-
  buildings[ ,
            .(meter_reading_mean = mean(meter_reading, na.rm = TRUE)
              ),
            by = list(site_id, date)
            ] %>% 
  split(.$site_id)

str(meter_reading_by_site_day$`0`)


line_daily_energy_overyr <-
  pmap(.l = list(a = meter_reading_by_site_day,
                 b = names(meter_reading_by_site_day)
                 ),
       .f = function(a, b) {
         ggplot(data = a,
                aes(x = date,
                    y = meter_reading_mean,
                    colour = site_id
                    )
                ) +
           geom_line() +
           # facet_wrap(vars(site_id)
           #            ) +
           labs(title = paste0("Electric Readings \n", "site_id: ", b)
                ) +
           theme_minimal() +
           theme(legend.position = "none") +
           NULL
       }
     )

line_daily_energy_overyr
line_daily_energy_overyr %>% map(~ggplotly(.x))

```






    
## Data Manipulation  
  
  Create a full dataset.
```{r}

tic()

joined_data <-
  # files_list$train %>%
  # left_join(y = files_list$building_metadata,
  #           by = c("building_id" = "building_id")
  #           ) %>%
  # left_join(y = files_list$weather_train,
  #           by = c("site_id" = "site_id",
  #                  "timestamp" = "timestamp"
  #                  )
  #           ) %>%
  # mutate(timestamp = as_datetime(timestamp),
  #        meter_reading_log = log(meter_reading + 1)
  #        ) %>%
  # mutate_if(is_character, factor) %>%
  # arrange(building_id,
  #         meter,
  #         timestamp
  #         )
  # files_list$train %>% 
  # bind_rows(files_list$test,
  #           .id = "data_type"
  #           ) %>% 
  merge(x = files_list$train,
        y = files_list$building_metadata,
        by.x = "building_id",
        by.y = "building_id",
        all.x = TRUE
        )

joined_data <-
  merge(x = joined_data,
        y = files_list$weather_train,
        by.x = c("site_id", "timestamp"),
        by.y = c("site_id", "timestamp"),
        all.x = TRUE
        )

joined_data <-
  joined_data[ , `:=` (# timestamp = as_datetime(timestamp),
                       primary_use = factor(primary_use) #,
                       # meter_reading_log = log(meter_reading + 1)#,
                       # data_type = if_else(data_type == "1",
                       #                     "train",
                       #                     "test"
                       #                     ) %>% factor()
                       )
               ] %>% 
  setkey(building_id,
         meter,
         timestamp
         )


toc()

# dim(joined_data)
class(joined_data)
str(joined_data)
# glimpse(joined_data)
# View(head(joined_data, 1000))

```
  
    
  Investigate times and counts of the training and test sets. Essentially, we need to use ~1 year of data, to predict the next ~2 years.
```{r}

train_test <-
  files_list$train %>% 
  bind_rows(files_list$test,
            .id = "data_type"
            )

train_test <- train_test[ , `:=` (data_type = if_else(data_type == "1",
                                                      "1_train",
                                                      "2_test"
                                                      )
                                  )
                          ]


cnts_train_test_bld_mtr <-
  train_test[ ,
              .(timestamp_min = min(timestamp, na.rm = TRUE),
                timestamp_max = max(timestamp, na.rm = TRUE),
                cnt_days = .N / 24
                ),
              by = list(data_type, building_id, meter)
              ][order(building_id, meter, data_type)]

View(cnts_train_test_bld_mtr)


rm(cnts_train_test_bld_mtr)

```
  
    
  Counts of positive meter readings by `primary_use`.
```{r}

joined_data %>% 
  count(primary_use) %>% 
  left_join(joined_data %>% 
              filter(meter_reading_log > 0) %>% 
              count(primary_use) %>% 
              rename(n_reading_abv_0 = n),
            by = "primary_use"
            ) %>% 
  mutate(n_reading_abv_0_pct = n_reading_abv_0 / n) %>% 
  arrange(desc(n_reading_abv_0_pct))
            
```  
  
    
  Quick investigation using line plots. It looks like there are often zero values - mostly before and/or after the "main" dataset.
```{r}

split_first_10_bldgs <-
  joined_data[building_id < 10] %>% 
  split(.$building_id)

# split_first_10_bldgs$`0` %>% 
#   pivot_longer(cols = c(meter_reading, meter_reading_log),
#                names_to = "reading_type",
#                values_to = "reading_value"
#                ) %>% 
#   View()

line_plots <-
  pmap(.l = list(a = split_first_10_bldgs,
                 b = names(split_first_10_bldgs)
                 ),
       .f = function(a, b) {
         a %>% 
           pivot_longer(cols = c(meter_reading, meter_reading_log),
                        names_to = "reading_type",
                        values_to = "reading_value"
                        ) %>% 
           ggplot(#data = a,
                  aes(x = timestamp,
                      y = reading_value,
                      # y = meter_reading_log,
                      colour = factor(meter)
                      )
                  ) +
           geom_line() +
           facet_wrap(vars(meter, reading_type),
                      scales = "free"
                      ) +
           labs(title = paste0("building_id: ", b)
                ) +
           theme_minimal() +
           theme(legend.position = "none")
         }
       )

line_plots


rm(line_plots)

```
  
    
  Inspect if train and test have the same combinations of `building_id` and `meter`. There are no unknown combinations of `building_id` and `meter` being asked to predict.
```{r}

bldg_mtr_train <-
  train_test[data_type == "1_train",
             list(building_id, meter)
             ][ ,
               bldg_mtr := paste0(building_id, "_", meter)
               ][order(building_id,
                       meter
                       )
               ]

message("bldg_mtr_train")
dim(bldg_mtr_train)


bldg_mtr_test <-
  train_test[data_type == "2_test",
             list(building_id, meter)
             ][ ,
               bldg_mtr := paste0(building_id, "_", meter)
               ][order(building_id,
                       meter
                       )
               ]

message("bldg_mtr_test")
dim(bldg_mtr_test)


message("setdiff")
setdiff(x = unique(bldg_mtr_train$bldg_mtr),
        y = unique(bldg_mtr_test$bldg_mtr)
        )



rm(bldg_mtr_train, bldg_mtr_test)

```
  
    
  Remove no-longer-needed files.
```{r}

rm(files_list)

```


## Feature Engineering


```{r}

# joined_data %>% str()
# View(joined_data %>% head(2000))

```



```{r}

# rolling_test_dt <-
#   frollmean(joined_data[ ,
#                         .(meter_reading_log),
#                         by = list(building_id, meter)
#                         ],
#             n = c(24, (24*2), (24*7)
#                   ),
#             algo = "fast",
#             align = "right"
#             )
# 
# 
# str(rolling_test_dt)
# View(rolling_test_dt[[4]] %>% head(1000))

```


```{r}

tic()

rolling_test_zoo <-
  joined_data[ ,
               `:=` (r_mean_roll_1day = rollmean(x = meter_reading_log,
                                                 k = 24,
                                                 na.pad = TRUE,
                                                 align = "right"
                                                 ),
                     r_mean_roll_2day = rollmean(x = meter_reading_log,
                                                 k = (24 * 2),
                                                 na.pad = TRUE,
                                                 align = "right"
                                                 ),
                     r_mean_roll_7day = rollmean(x = meter_reading_log,
                                                 k = (24 * 7),
                                                 na.pad = TRUE,
                                                 align = "right"
                                                 ),
                     l_mean_roll_1day = rollmean(x = meter_reading_log,
                                                 k = 24,
                                                 na.pad = TRUE,
                                                 align = "left"
                                                 ),
                     l_mean_roll_2day = rollmean(x = meter_reading_log,
                                                 k = (24 * 2),
                                                 na.pad = TRUE,
                                                 align = "left"
                                                 ),
                     l_mean_roll_7day = rollmean(x = meter_reading_log,
                                                 k = (24 * 7),
                                                 na.pad = TRUE,
                                                 align = "left"
                                                 )
                     ),
               by = list(building_id, meter)
              ]

toc()


str(rolling_test_zoo)
View(rolling_test_zoo %>% head(1000))
View(rolling_test_zoo %>% tail(1000))


# rm(joined_data)

```



```{r}

split_first_10_bldgs <-
  rolling_test_zoo[building_id < 10] %>% 
  filter(r_mean_roll_1day > 0) %>% 
  split(.$building_id)

# split_first_10_bldgs$`0` %>% 
#   pivot_longer(cols = c(meter_reading, meter_reading_log),
#                names_to = "reading_type",
#                values_to = "reading_value"
#                ) %>% 
#   View()

line_plots <-
  pmap(.l = list(a = split_first_10_bldgs,
                 b = names(split_first_10_bldgs)
                 ),
       .f = function(a, b) {
         a %>% 
           pivot_longer(cols = c(meter_reading, meter_reading_log),
                        names_to = "reading_type",
                        values_to = "reading_value"
                        ) %>% 
           ggplot(#data = a,
                  aes(x = timestamp,
                      y = reading_value,
                      # y = meter_reading_log,
                      colour = factor(meter)
                      )
                  ) +
           geom_line() +
           facet_wrap(vars(meter, reading_type),
                      scales = "free"
                      ) +
           labs(title = paste0("building_id: ", b)
                ) +
           theme_minimal() +
           theme(legend.position = "none")
         }
       )

line_plots


rm(line_plots)

```




```{r}

# # Custom function to return mean, sd, 95% conf interval
# custom_stat_fun <- function(x, na.rm = TRUE) {
#     # x     = numeric vector
#     # na.rm = boolean, whether or not to remove NA's
#     
#     m  = mean(x, na.rm = na.rm)
#     s  = sd(x, na.rm = na.rm)
#     hi = m + 2*s
#     lo = m - 2*s
#     
#     ret = c(mean = m,
#             stdev = s,
#             hi.95 = hi,
#             lo.95 = lo
#             )
#     
#     return(ret)
#     }

```


```{r}

# # Roll apply using custom stat function
# rolling_test_tidyquant <-
#   joined_data %>% 
#   group_by(building_id,
#            meter
#            ) %>% 
#   tq_mutate(
#     select     = meter_reading_log,
#     mutate_fun = rollapply, 
#     # rollapply args
#     width      = 24,
#     align      = "right",
#     by.column  = FALSE,
#     FUN        = custom_stat_fun,
#     # FUN args
#     na.rm      = TRUE
#     ) %>% 
#   ungroup()
# 
# str(rolling_test_tidyquant)

```





```{r}

# rm(buildings, joined_data, rolling_test_zoo, train_test)

```




